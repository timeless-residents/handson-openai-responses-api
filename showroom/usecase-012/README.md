# ユースケース 012: 複数画像の分析と比較

このユースケースでは、OpenAI Responses APIを使用して複数の画像を同時に分析し、それらの間の関係、パターン、相違点を詳細に比較する方法を紹介します。

## 概要

複数の画像を系統的に分析することで、単一画像分析では得られない洞察を抽出できます。このサンプルでは、複数画像の比較分析を通じて以下のような高度な活用法を示します：

- 体系的な比較基準に基づく分析
- 画像間のパターンや関連性の検出
- スタイルとコンテンツの分離分析
- 専門分野（芸術・デザイン分析など）への応用

このサンプルでは、以下の4つの異なる例を通じて複数画像分析の可能性を示します：

1. **基本的な比較分析**: 複数の画像を定義された基準で体系的に比較
2. **パターン検出**: 複数の画像間に共通するビジュアル要素やパターンの特定
3. **スタイルとコンテンツの分離**: 表現方法と被写体・題材の分離分析
4. **特殊なユースケース**: 芸術作品の専門的な比較分析

## 実行方法

1. プロジェクトのルートディレクトリに`.env`ファイルを作成し、OpenAI APIキーを設定します：

```
OPENAI_API_KEY=your_api_key_here
```

2. 必要なパッケージをインストールします：

```bash
pip install -r requirements.txt
```

3. スクリプトを実行します：

```bash
python main.py
```

## 技術的な実装

### 比較基準の定義と表形式出力

体系的な比較のために明示的な比較基準を定義し、結果を表形式で出力します：

```python
# 比較基準の定義
criteria = [
    "視覚的要素（色彩、構図、主な被写体）",
    "伝達される雰囲気や感情",
    "想定される用途や目的",
    "技術的品質（解像度、明瞭さ、バランス）",
    "視聴者へのインパクトと印象"
]

# 比較分析の実行とJSONフォーマットでの出力
response = generate_comparative_analysis(client, image_paths, criteria)
```

### 画像メタデータの活用

画像のメタデータを抽出して分析の参考情報として表示します：

```python
def get_image_metadata(image_path):
    """画像のメタデータを取得します。"""
    metadata = {
        "filename": os.path.basename(image_path),
        "size_bytes": os.path.getsize(image_path),
    }
    
    if PIL_AVAILABLE:
        try:
            with Image.open(image_path) as img:
                metadata["format"] = img.format
                metadata["mode"] = img.mode
                metadata["width"] = img.width
                metadata["height"] = img.height
                metadata["aspect_ratio"] = round(img.width / img.height, 2)
        except Exception as e:
            print(f"画像メタデータの取得に失敗しました: {e}")
    
    return metadata
```

### バッチ処理による複数画像分析

複数の画像を効率的に処理するバッチ処理アプローチを実装しています：

```python
def analyze_multiple_images(client, image_paths, prompt):
    """複数の画像を分析します。"""
    # 入力形式を構築
    content = [{"type": "text", "text": prompt}]
    
    # 画像を追加
    for path in image_paths:
        base64_image = encode_image_to_base64(path)
        content.append({
            "type": "image_url",
            "image_url": {
                "url": f"data:image/jpeg;base64,{base64_image}"
            }
        })
    
    # APIリクエスト
    response = client.chat.completions.create(
        model="gpt-4o",
        messages=[{"role": "user", "content": content}]
    )
    
    return response
```

## サンプル例の詳細

### 例1: 基本的な比較分析

複数の画像を定義された評価基準に沿って体系的に比較します。各基準について各画像を評価し、結果を比較表形式で出力します。さらに、全体的な分析と画像固有の特徴もまとめます。

**主な特徴**:
- 複数の明示的評価基準
- 構造化されたJSON出力
- 表形式での結果表示
- 総合分析と個別特徴の抽出

### 例2: パターン検出

複数の画像を分析して、共通する視覚的要素やパターンを特定します。画像間の類似性、繰り返しパターン、テーマの一貫性などを見つけ出します。

**主な特徴**:
- 共通要素の抽出
- 繰り返しパターンの検出
- カテゴリー分類
- 画像間の関連性分析

### 例3: スタイルとコンテンツの分離

画像のスタイル（表現方法）とコンテンツ（被写体・題材）を分離して分析します。色使い、構図、技法などのスタイル要素と主題、物語性、象徴的意味などのコンテンツ要素を区別します。

**主な特徴**:
- スタイル特性の分析
- コンテンツ要素の抽出
- スタイルとコンテンツの分離と比較
- 視覚表現の層別解析

### 例4: 特殊なユースケース（芸術分析）

美術史の専門家の視点から画像を分析する特殊なユースケースです。芸術様式、技法、構図、色彩理論、芸術的意義などの観点から専門的な分析を行います。

**主な特徴**:
- 専門分野に特化した分析
- 技術的・歴史的文脈での評価
- 専門的視点での解釈
- 教育的・解説的なアプローチ

## 応用例

複数画像の分析と比較は以下のような用途に適しています：

1. **美術・デザイン評価**: 作品間の比較、スタイル分析、影響関係の探索
2. **製品カタログ**: 類似製品の自動比較と差別化ポイントの抽出
3. **不動産写真分析**: 複数物件の特徴比較と環境評価
4. **医療画像診断支援**: 時系列画像の変化検出と進行分析
5. **遠隔地調査**: 衛星・航空写真の経時変化の検出と分析
6. **品質管理**: 製造品の視覚的検査と不良品検出

## 実装上の注意点

- 一度に分析できる画像の数には制限があるため、適切な数に制限することが重要です
- 大量の画像を送信するとトークン使用量とコストが急増する可能性があります
- 比較分析の精度を高めるには、比較基準を明確に定義することが重要です
- 専門分野の分析では、その分野に関する背景知識や専門用語をプロンプトに含めると効果的です
- 構造化された出力が必要な場合は、JSON形式での応答を具体的に要求してください

## 追加リソース

- [OpenAI Chat Completions API ドキュメント](https://platform.openai.com/docs/api-reference/chat)
- [OpenAI マルチモーダル機能ガイド](https://platform.openai.com/docs/guides/vision)
- [画像処理ライブラリ Pillow ドキュメント](https://pillow.readthedocs.io/)