<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ subject.name }} - {{ topic }} 練習問題 - 教育コンテンツ生成システム</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Helvetica Neue', Arial, sans-serif;
        }
        .header {
            background-color: #343a40;
            color: white;
            padding: 1.5rem 0;
            margin-bottom: 2rem;
        }
        .main-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .content-section {
            font-size: 1.1rem;
            line-height: 1.7;
        }
        .content-section h1 { font-size: 2.2rem; margin-top: 1.5rem; }
        .content-section h2 { font-size: 1.8rem; margin-top: 1.5rem; }
        .content-section h3 { font-size: 1.5rem; margin-top: 1.2rem; }
        .content-section pre {
            background-color: #f5f5f5;
            padding: 1rem;
            border-radius: 5px;
        }
        .problem-card {
            margin-bottom: 2rem;
            border-left: 5px solid #007bff;
        }
        .solution {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .user-answer-section {
            margin-top: 1rem;
        }
        .feedback-section {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 5px;
        }
        .score-display {
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="header text-center">
        <h1>{{ subject.name }} - {{ topic }}</h1>
        <p class="lead">{{ user_session['profile']['level'] }} 向け練習問題</p>
    </div>

    <div class="container main-container">
        <div class="row">
            <div class="col-md-12 mb-4">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{{ url_for('select_subject') }}">科目選択</a></li>
                        <li class="breadcrumb-item"><a href="{{ url_for('select_topic', subject=subject_key) }}">{{ subject.name }}</a></li>
                        <li class="breadcrumb-item"><a href="{{ url_for('learning', subject=subject_key, topic=topic) }}">{{ topic }}</a></li>
                        <li class="breadcrumb-item active" aria-current="page">練習問題</li>
                    </ol>
                </nav>
                
                <h2>練習問題</h2>
                <p>以下の問題を解いて理解度を確認しましょう。各問題に回答した後、「回答を評価」ボタンをクリックすると、フィードバックが表示されます。</p>
                <hr>
            </div>
        </div>

        <div id="problems-container" class="content-section">
            {{ problems|safe }}
        </div>
        
        <div class="row mt-4">
            <div class="col-md-12">
                <a href="{{ url_for('learning', subject=subject_key, topic=topic) }}" class="btn btn-primary">教材に戻る</a>
                <button id="regenerateBtn" class="btn btn-success">新しい問題を生成</button>
            </div>
        </div>
    </div>

    <footer class="text-center mt-5 mb-3">
        <p>&copy; 2025 教育コンテンツ生成システム - OpenAI Responses API ハンズオン</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 問題と解答を処理
            processPracticeProblems();
            
            // 問題再生成ボタン
            document.getElementById('regenerateBtn').addEventListener('click', function() {
                window.location.reload();
            });
        });
        
        function processPracticeProblems() {
            // Markdownが適切に処理されていることを前提とする
            const problemsContainer = document.getElementById('problems-container');
            
            // H3要素を問題のタイトルと見なし、各問題をカードに変換
            const problems = problemsContainer.querySelectorAll('h3, h2');
            
            problems.forEach((problem, index) => {
                if (problem.textContent.includes('問題') || problem.textContent.includes('練習問題')) {
                    // 問題のセクションを見つける
                    let problemContent = extractProblemContent(problem);
                    
                    // 問題と解答部分を分離
                    const hasSolution = problemContent.innerHTML.includes('解答') || 
                                      problemContent.innerHTML.includes('答え') || 
                                      problemContent.innerHTML.includes('解説');
                    
                    if (hasSolution) {
                        // オリジナルのコンテンツを保存
                        const originalContent = problemContent.innerHTML;
                        
                        // 解答部分を非表示にする新しいHTML
                        let newHTML = createProblemCard(problem.textContent, originalContent, index);
                        
                        // オリジナルのコンテンツを削除して新しいカードに置き換え
                        let wrapper = document.createElement('div');
                        wrapper.innerHTML = newHTML;
                        problemContent.parentNode.insertBefore(wrapper, problemContent);
                        problemContent.remove();
                        problem.remove();
                    }
                }
            });
            
            // 「解答を表示」ボタンのイベントハンドラ
            document.querySelectorAll('.show-solution-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const problemId = this.getAttribute('data-problem-id');
                    const solutionElement = document.getElementById(`solution-${problemId}`);
                    
                    if (solutionElement.style.display === 'none' || !solutionElement.style.display) {
                        solutionElement.style.display = 'block';
                        this.textContent = '解答を隠す';
                    } else {
                        solutionElement.style.display = 'none';
                        this.textContent = '解答を表示';
                    }
                });
            });
            
            // 回答評価ボタンのイベントハンドラ
            document.querySelectorAll('.evaluate-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const problemId = this.getAttribute('data-problem-id');
                    const userAnswer = document.getElementById(`answer-${problemId}`).value.trim();
                    const questionText = document.getElementById(`question-${problemId}`).textContent;
                    const correctAnswer = document.getElementById(`correct-answer-${problemId}`).textContent;
                    
                    if (!userAnswer) {
                        alert('回答を入力してください');
                        return;
                    }
                    
                    // 評価処理中の表示
                    this.disabled = true;
                    this.textContent = '評価中...';
                    const btn = this;
                    
                    // APIリクエスト送信
                    fetch('/evaluate_answer', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            subject: '{{ subject_key }}',
                            topic: '{{ topic }}',
                            question: questionText,
                            user_answer: userAnswer,
                            correct_answer: correctAnswer
                        }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        // フィードバック表示
                        const feedbackElement = document.getElementById(`feedback-${problemId}`);
                        feedbackElement.innerHTML = data.feedback;
                        feedbackElement.style.display = 'block';
                        
                        // スコア表示
                        const scoreElement = document.getElementById(`score-${problemId}`);
                        const score = Math.round(data.understanding_score * 100);
                        scoreElement.textContent = `理解度スコア: ${score}%`;
                        
                        if (score >= 80) {
                            scoreElement.classList.add('text-success');
                        } else if (score >= 50) {
                            scoreElement.classList.add('text-warning');
                        } else {
                            scoreElement.classList.add('text-danger');
                        }
                        
                        scoreElement.style.display = 'block';
                        
                        // ボタン状態の復元
                        btn.disabled = false;
                        btn.textContent = '回答を再評価';
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('エラーが発生しました。もう一度お試しください。');
                        
                        // ボタン状態の復元
                        btn.disabled = false;
                        btn.textContent = '回答を評価';
                    });
                });
            });
        }
        
        function extractProblemContent(problemHeading) {
            let content = problemHeading;
            let siblings = [];
            
            // 次の問題見出しまでの要素を集める
            while (content.nextElementSibling) {
                if (content.nextElementSibling.tagName === 'H2' || content.nextElementSibling.tagName === 'H3') {
                    if (content.nextElementSibling.textContent.includes('問題') || 
                        content.nextElementSibling.textContent.includes('練習問題')) {
                        break;
                    }
                }
                siblings.push(content.nextElementSibling);
                content = content.nextElementSibling;
            }
            
            // 問題内容を含むコンテナを作成
            const container = document.createElement('div');
            siblings.forEach(sibling => {
                container.appendChild(sibling.cloneNode(true));
            });
            
            return container;
        }
        
        function createProblemCard(title, content, index) {
            // 解答部分を特定
            const solutionStart = content.indexOf('<h4>解答</h4>') !== -1 ? content.indexOf('<h4>解答</h4>') :
                                content.indexOf('<h4>答え</h4>') !== -1 ? content.indexOf('<h4>答え</h4>') :
                                content.indexOf('<h4>解説</h4>') !== -1 ? content.indexOf('<h4>解説</h4>') :
                                content.indexOf('<strong>解答</strong>') !== -1 ? content.indexOf('<strong>解答</strong>') :
                                content.indexOf('<strong>答え</strong>') !== -1 ? content.indexOf('<strong>答え</strong>') :
                                content.indexOf('<strong>解説</strong>') !== -1 ? content.indexOf('<strong>解説</strong>') :
                                -1;
            
            if (solutionStart === -1) {
                // 解答部分が見つからない場合はそのまま返す
                return `
                <div class="card problem-card mb-4">
                    <div class="card-header">
                        <h3>${title}</h3>
                    </div>
                    <div class="card-body">
                        ${content}
                    </div>
                </div>`;
            }
            
            // 問題文と解答を分離
            const questionText = content.substring(0, solutionStart);
            const solutionText = content.substring(solutionStart);
            
            return `
            <div class="card problem-card mb-4">
                <div class="card-header">
                    <h3>${title}</h3>
                </div>
                <div class="card-body">
                    <div id="question-${index}" class="question-section">
                        ${questionText}
                    </div>
                    
                    <div class="user-answer-section">
                        <div class="form-group">
                            <label for="answer-${index}"><strong>あなたの回答:</strong></label>
                            <textarea id="answer-${index}" class="form-control" rows="4" placeholder="ここに回答を入力してください..."></textarea>
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-primary evaluate-btn" data-problem-id="${index}">回答を評価</button>
                            <button class="btn btn-outline-secondary show-solution-btn" data-problem-id="${index}">解答を表示</button>
                        </div>
                    </div>
                    
                    <div class="score-display" id="score-${index}" style="display: none;"></div>
                    
                    <div id="feedback-${index}" class="feedback-section"></div>
                    
                    <div id="solution-${index}" class="solution">
                        <div id="correct-answer-${index}" style="display: none;">${solutionText}</div>
                        ${solutionText}
                    </div>
                </div>
            </div>`;
        }
    </script>
</body>
</html>